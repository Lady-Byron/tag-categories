{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://lady-byron-tag-categories/webpack/bootstrap","webpack://lady-byron-tag-categories/webpack/runtime/compat get default export","webpack://lady-byron-tag-categories/webpack/runtime/define property getters","webpack://lady-byron-tag-categories/webpack/runtime/hasOwnProperty shorthand","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['forum/app']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/extend']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['forum/utils/DiscussionControls']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/components/Button']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/TagDiscussionModal']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/TagSelectionModal']\"","webpack://lady-byron-tag-categories/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/utils/classList']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/helpers/highlight']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/components/LoadingIndicator']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/utils/extractText']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/common/helpers/tagIcon']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/common/helpers/tagLabel']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/ToggleButton']\"","webpack://lady-byron-tag-categories/./src/forum/components/GroupedTagDiscussionModal.tsx","webpack://lady-byron-tag-categories/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://lady-byron-tag-categories/./src/forum/index.tsx"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/utils/DiscussionControls'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/TagDiscussionModal'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/TagSelectionModal'];","function _setPrototypeOf(t, e) {\n  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) {\n    return t.__proto__ = e, t;\n  }, _setPrototypeOf(t, e);\n}\nexport { _setPrototypeOf as default };","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/classList'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/highlight'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/LoadingIndicator'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/extractText'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/common/helpers/tagIcon'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/common/helpers/tagLabel'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/ToggleButton'];","// js/src/forum/components/GroupedTagDiscussionModal.tsx\nimport app from 'flarum/forum/app'; \nimport Button from 'flarum/common/components/Button';\nimport classList from 'flarum/common/utils/classList';\nimport highlight from 'flarum/common/helpers/highlight';\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\nimport extractText from 'flarum/common/utils/extractText';\n\nimport TagDiscussionModal, { type TagDiscussionModalAttrs } from 'flarum/tags/forum/components/TagDiscussionModal';\nimport tagIcon from 'flarum/tags/common/helpers/tagIcon';\nimport tagLabel from 'flarum/tags/common/helpers/tagLabel';\nimport ToggleButton from 'flarum/tags/forum/components/ToggleButton';\nimport type Tag from 'flarum/tags/common/models/Tag';\n\ntype Vnode = Mithril.Vnode<TagDiscussionModalAttrs, GroupedTagDiscussionModal>;\n\ninterface ForumTagCategory {\n  id: number;\n  name: string;\n  slug: string | null;\n  order: number | null;\n  tagIds: number[];\n}\n\n/** 与原生一致的宽度计算：CJK 算 2 个字符宽 */\nfunction lengthWithCJK(text: string) {\n  let len = 0;\n  for (const ch of text || '') {\n    len += /[\\u4E00-\\u9FFF\\u3400-\\u4DBF\\uF900-\\uFAFF]/.test(ch) ? 2 : 1;\n  }\n  return len;\n}\n\nexport default class GroupedTagDiscussionModal extends TagDiscussionModal<TagDiscussionModalAttrs> {\n  /** 折叠分组集合 */\n  collapsedGroups!: Set<string>;\n  /** 仅在首次渲染设置默认折叠 */\n  private initialized = false;\n\n  /** 方案B：仅首开时允许 onready 聚焦；其后忽略 */\n  private _didInitialReady = false;\n\n  // 显式允许三种关闭方式，避免被其它扩展改写默认值后不可关闭\n  static isDismissibleViaEscKey = true;\n  static isDismissibleViaBackdropClick = true;\n  static isDismissibleViaCloseButton = true;\n\n  oninit(vnode: Vnode) {\n    super.oninit(vnode);\n    this.collapsedGroups = new Set();\n    this.initialized = false;\n    this._didInitialReady = false;\n  }\n\n  oncreate(vnode: Mithril.VnodeDOM) {\n    super.oncreate(vnode);\n    // 只把右上角 X 设为非提交按钮，防止 submit；不要自定义 onclick（避免 double-close 污染全局 ModalManager）\n    const closeBtn = this.element?.querySelector<HTMLButtonElement>('.Modal-close');\n    if (closeBtn && !closeBtn.getAttribute('type')) {\n      closeBtn.setAttribute('type', 'button');\n    }\n  }\n\n  /** 覆写 onready：仅首开时聚焦输入框；其后由 toggle/remove 触发的 onready() 将被忽略 */\n  onready() {\n    if (this._didInitialReady) return;\n    this._didInitialReady = true;\n\n    // 尽量避免首开时拉顶：支持的话使用 preventScroll\n    const input = this.element?.querySelector<HTMLInputElement>('.TagsInput input');\n    if (input && typeof (input as any).focus === 'function') {\n      try {\n        (input as any).focus({ preventScroll: true } as any);\n        return;\n      } catch {\n        input.focus();\n        return;\n      }\n    }\n\n    // 找不到输入框则回退到父类默认行为\n    // @ts-ignore\n    super.onready?.();\n  }\n\n  view(vnode: Vnode) {\n    return super.view(vnode);\n  }\n\n  content() {\n    // @ts-ignore inherited\n    if (this.loading || !this.tags) return <LoadingIndicator />;\n\n    // ===== 原生顶部（chips + 输入 + 提交）保留 =====\n    // @ts-ignore inherited\n    const primaryCount = this.primaryCount();\n    // @ts-ignore inherited\n    const secondaryCount = this.secondaryCount();\n    // @ts-ignore inherited\n    const filteredTags: Tag[] = this.getFilteredTags();\n\n    const instruction = extractText(\n      // @ts-ignore inherited\n      this.getInstruction(primaryCount, secondaryCount)\n    );\n    // @ts-ignore inherited\n    const inputWidth = Math.max(lengthWithCJK(instruction), lengthWithCJK(this.filter()));\n\n    // ====== 分组逻辑（替换列表部分）======\n    const categories: ForumTagCategory[] = (app.forum.attribute('tagCategories') as ForumTagCategory[]) || [];\n    const id2tag = new Map<number, Tag>(filteredTags.map((t) => [Number(t.id()), t]));\n\n    const grouped = categories\n      .map((g) => ({\n        group: g,\n        tags: (g.tagIds || []).map((id) => id2tag.get(Number(id))).filter(Boolean) as Tag[],\n      }))\n      .filter((e) => e.tags.length);\n\n    const groupedIdSet = new Set<number>();\n    grouped.forEach((e) => e.tags.forEach((t) => groupedIdSet.add(Number(t.id()))));\n    const ungrouped = filteredTags.filter((t) => !groupedIdSet.has(Number(t.id())));\n\n    const listItems: Mithril.Children[] = [];\n\n    // 默认折叠：除第一个分组外的所有分组 + 未分组\n    if (!this.initialized) {\n      grouped.forEach(({ group }, index) => {\n        if (index > 0) this.collapsedGroups.add(uniqueKeyForGroup(group));\n      });\n      if (ungrouped.length) this.collapsedGroups.add('__ungrouped__');\n      this.initialized = true;\n    }\n\n    const toggleGroup = (groupName: string) => {\n      if (this.collapsedGroups.has(groupName)) this.collapsedGroups.delete(groupName);\n      else this.collapsedGroups.add(groupName);\n    };\n\n    // 若没有有效分组，完全回退到原生列表（外观/交互不变）\n    if (!grouped.length) {\n      listItems.push(\n        ...filteredTags.map((tag) => this.renderTagLi(tag, `li-${tag.id()}`))\n      );\n    } else {\n      // 渲染分组列表，并区分第一个分组\n      grouped.forEach(({ group, tags }, index) => {\n        const gKey = uniqueKeyForGroup(group);\n\n        if (index === 0) {\n          // 第一个分组不折叠\n          listItems.push(\n            <li key={`gh-${gKey}`} className=\"TagSelectionModal-groupHeader non-collapsible\">\n              {group.name}\n            </li>\n          );\n          listItems.push(\n            ...tags.map((tag) => this.renderTagLi(tag, `li-${gKey}-${tag.id()}`))\n          );\n        } else {\n          const isCollapsed = this.collapsedGroups.has(gKey);\n          listItems.push(\n            <li\n              key={`gh-${gKey}`}\n              className={classList('TagSelectionModal-groupHeader', { collapsed: isCollapsed })}\n              role=\"button\"\n              aria-expanded={!isCollapsed}\n              tabindex=\"0\"\n              onclick={() => toggleGroup(gKey)}\n              onkeydown={(e: KeyboardEvent) => {\n                if (e.key === 'Enter' || e.key === ' ') {\n                  e.preventDefault();\n                  toggleGroup(gKey);\n                }\n              }}\n            >\n              <i className=\"fas fa-chevron-down TagSelectionModal-groupHeader-caret\" />\n              {group.name}\n            </li>\n          );\n          if (!isCollapsed) {\n            listItems.push(\n              ...tags.map((tag) => this.renderTagLi(tag, `li-${gKey}-${tag.id()}`))\n            );\n          }\n        }\n      });\n\n      // 渲染未分组（可折叠）\n      if (ungrouped.length) {\n        const ungroupedKey = '__ungrouped__';\n        const isCollapsed = this.collapsedGroups.has(ungroupedKey);\n        listItems.push(\n          <li\n            key={`gh-${ungroupedKey}`}\n            className={classList('TagSelectionModal-groupHeader', { collapsed: isCollapsed })}\n            role=\"button\"\n            aria-expanded={!isCollapsed}\n            tabindex=\"0\"\n            onclick={() => toggleGroup(ungroupedKey)}\n            onkeydown={(e: KeyboardEvent) => {\n              if (e.key === 'Enter' || e.key === ' ') {\n                e.preventDefault();\n                toggleGroup(ungroupedKey);\n              }\n            }}\n          >\n            <i className=\"fas fa-chevron-down TagSelectionModal-groupHeader-caret\" />\n            {app.translator.trans('lady-byron-tag-categories.forum.tag_selection.ungrouped')}\n          </li>\n        );\n        if (!isCollapsed) {\n          listItems.push(\n            ...ungrouped.map((tag) => this.renderTagLi(tag, `li-${ungroupedKey}-${tag.id()}`))\n          );\n        }\n      }\n    }\n\n    // ===== 原生骨架（body + footer） =====\n    return [\n      <div className=\"Modal-body\">\n        <div className=\"TagSelectionModal-form\">\n          <div className=\"TagSelectionModal-form-input\">\n            <div\n              // @ts-ignore inherited\n              className={'TagsInput FormControl ' + (this.focused ? 'focus' : '')}\n              onclick={() => this.$('.TagsInput input').focus()}\n            >\n              <span className=\"TagsInput-selected\">\n                {\n                  // @ts-ignore inherited\n                  this.selected.map((tag: Tag) => (\n                    <span\n                      key={`sel-${tag.id()}`}\n                      className=\"TagsInput-tag\"\n                      onclick={() => {\n                        // @ts-ignore inherited\n                        this.removeTag(tag);\n                        // 保持原文件逻辑：依然调用 onready（但因为覆写+已首开，后续不会再聚焦/拉顶）\n                        // @ts-ignore\n                        this.onready();\n                      }}\n                    >\n                      {tagLabel(tag)}\n                    </span>\n                  ))\n                }\n              </span>\n              <input\n                className=\"FormControl\"\n                placeholder={instruction}\n                // @ts-ignore inherited\n                bidi={this.filter}\n                style={{ width: inputWidth + 'ch' }}\n                // @ts-ignore inherited\n                onkeydown={this.navigator.navigate.bind(this.navigator)}\n                // @ts-ignore inherited\n                onfocus={() => (this.focused = true)}\n                // @ts-ignore inherited\n                onblur={() => (this.focused = false)}\n              />\n            </div>\n          </div>\n          <div className=\"TagSelectionModal-form-submit App-primaryControl\">\n            <Button\n              type=\"submit\"\n              className=\"Button Button--primary\"\n              // @ts-ignore inherited\n              disabled={!this.meetsRequirements(primaryCount, secondaryCount)}\n              icon=\"fas fa-check\"\n            >\n              {app.translator.trans('flarum-tags.lib.tag_selection_modal.submit_button')}\n            </Button>\n          </div>\n        </div>\n      </div>,\n\n      <div className=\"Modal-footer\">\n        <ul className=\"TagSelectionModal-list SelectTagList\">{listItems}</ul>\n\n        {\n          // @ts-ignore inherited\n          this.attrs.limits?.allowBypassing && (\n            <div className=\"TagSelectionModal-controls\">\n              {\n                // @ts-ignore inherited\n                <ToggleButton className=\"Button\" onclick={() => (this.bypassReqs = !this.bypassReqs)} isToggled={this.bypassReqs}>\n                  {app.translator.trans('flarum-tags.lib.tag_selection_modal.bypass_requirements')}\n                </ToggleButton>\n              }\n            </div>\n          )\n        }\n      </div>,\n    ];\n  }\n\n  /** 单个标签项 —— 完全沿用原生 DOM/类名/交互（补上 key） */\n  private renderTagLi(tag: Tag, vkey?: string) {\n    // @ts-ignore inherited\n    const selected = this.selected.includes(tag);\n    // @ts-ignore inherited\n    const active = this.indexTag === tag;\n    // @ts-ignore inherited\n    const filterStr: string = this.filter().toLowerCase();\n\n    return (\n      <li\n        key={vkey ?? `li-${tag.id()}`}\n        data-index={tag.id()}\n        className={classList('SelectTagListItem', {\n          pinned: tag.position() !== null,\n          child: !!tag.parent(),\n          colored: !!tag.color(),\n          selected,\n          active,\n        })}\n        style={{ color: tag.color() || undefined }}\n        // @ts-ignore inherited\n        onmouseover={() => (this.indexTag = tag)}\n        // @ts-ignore inherited\n        onclick={this.toggleTag.bind(this, tag)}\n      >\n        <i className=\"SelectTagListItem-icon\">\n          {\n            tag.icon()\n              ? tagIcon(tag, { className: 'SelectTagListItem-tagIcon' })\n              : (selected\n                  ? <i className=\"icon TagIcon fas fa-check SelectTagListItem-checkIcon\" style={{ color: 'black' }} />\n                  : tagIcon(tag, { className: 'SelectTagListItem-tagIcon' })\n                )\n          }\n        </i>\n        <span className=\"SelectTagListItem-name\">{highlight(tag.name(), filterStr)}</span>\n        {tag.description() ? <span className=\"SelectTagListItem-description\">{tag.description()}</span> : ''}\n      </li>\n    );\n  }\n}\n\nfunction uniqueKeyForGroup(g: ForumTagCategory) {\n  return String(g.id ?? g.slug ?? g.name);\n}\n","import setPrototypeOf from \"./setPrototypeOf.js\";\nfunction _inheritsLoose(t, o) {\n  t.prototype = Object.create(o.prototype), t.prototype.constructor = t, setPrototypeOf(t, o);\n}\nexport { _inheritsLoose as default };","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionControls from 'flarum/forum/utils/DiscussionControls';\nimport Button from 'flarum/common/components/Button';\n\n// 原生弹窗\nimport TagDiscussionModal from 'flarum/tags/forum/components/TagDiscussionModal';\nimport TagSelectionModal from 'flarum/tags/forum/components/TagSelectionModal';\n\n// 我们的分组版弹窗（同时兼容“编辑已有讨论”和“新建时选择”两种场景）\nimport GroupedTagDiscussionModal from './components/GroupedTagDiscussionModal';\n\nconst EXT_ID = 'lady-byron/tag-categories';\n\napp.initializers.add(EXT_ID, () => {\n  const originalShow = app.modal.show.bind(app.modal);\n\n  // ✅ 统一在 show 入口替换，不在 oninit 里做切换，避免 Nested m.redraw.sync\n  (app.modal as any).show = function (component: any, attrs: any) {\n    const groups = app.forum.attribute('tagCategories') || [];\n\n    // 仅当站点存在分类组时才替换，保持无分组时沿用原生体验\n    if (groups.length && (component === TagDiscussionModal || component === TagSelectionModal)) {\n      component = GroupedTagDiscussionModal;\n    }\n\n    return originalShow(component, attrs);\n  };\n\n  // 兜底：讨论页“编辑标签”按钮也强制打开分组版\n  extend(DiscussionControls, 'moderationControls', function (items, discussion) {\n    if (discussion.canTag && discussion.canTag()) {\n      items.add(\n        'tags',\n        <Button icon=\"fas fa-tag\" onclick={() => app.modal.show(GroupedTagDiscussionModal, { discussion })}>\n          {app.translator.trans('flarum-tags.forum.discussion_controls.edit_tags_button')}\n        </Button>,\n        100\n      );\n    }\n  });\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","_setPrototypeOf","t","e","setPrototypeOf","bind","__proto__","lengthWithCJK","text","_step","len","_iterator","_createForOfIteratorHelperLoose","done","ch","value","test","GroupedTagDiscussionModal","_TagDiscussionModal","_this","_len","arguments","length","args","Array","_key","apply","concat","collapsedGroups","initialized","_didInitialReady","create","constructor","_proto","oninit","vnode","this","Set","oncreate","_this$element","closeBtn","element","querySelector","getAttribute","setAttribute","onready","_this$element2","_TagDiscussionModal$p","input","focus","preventScroll","_unused","view","content","_this$attrs$limits","_this2","loading","tags","m","LoadingIndicator","primaryCount","secondaryCount","filteredTags","getFilteredTags","instruction","extractText","getInstruction","inputWidth","Math","max","filter","categories","app","attribute","id2tag","Map","map","Number","id","grouped","g","group","tagIds","Boolean","groupedIdSet","forEach","add","ungrouped","has","listItems","_ref","index","uniqueKeyForGroup","toggleGroup","groupName","_ref2","gKey","push","className","name","tag","renderTagLi","isCollapsed","classList","collapsed","role","tabindex","onclick","onkeydown","preventDefault","ungroupedKey","trans","focused","$","selected","removeTag","tagLabel","placeholder","bidi","style","width","navigator","navigate","onfocus","onblur","Button","type","disabled","meetsRequirements","icon","attrs","limits","allowBypassing","ToggleButton","bypassReqs","isToggled","vkey","_this3","includes","active","indexTag","filterStr","toLowerCase","pinned","position","child","parent","colored","color","undefined","onmouseover","toggleTag","tagIcon","highlight","description","TagDiscussionModal","_ref3","_g$id","String","slug","isDismissibleViaEscKey","isDismissibleViaBackdropClick","isDismissibleViaCloseButton","originalShow","show","component","TagSelectionModal","extend","DiscussionControls","items","discussion","canTag"],"sourceRoot":""}