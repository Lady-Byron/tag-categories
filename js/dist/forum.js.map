{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://lady-byron-tag-categories/webpack/bootstrap","webpack://lady-byron-tag-categories/webpack/runtime/compat get default export","webpack://lady-byron-tag-categories/webpack/runtime/define property getters","webpack://lady-byron-tag-categories/webpack/runtime/hasOwnProperty shorthand","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['forum/app']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/extend']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['forum/utils/DiscussionControls']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/components/Button']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/TagDiscussionModal']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/TagSelectionModal']\"","webpack://lady-byron-tag-categories/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/utils/classList']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/helpers/highlight']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/components/LoadingIndicator']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/common/helpers/tagIcon']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/common/utils/sortTags']\"","webpack://lady-byron-tag-categories/./src/forum/components/GroupedTagDiscussionModal.tsx","webpack://lady-byron-tag-categories/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://lady-byron-tag-categories/./src/forum/index.tsx"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/utils/DiscussionControls'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/TagDiscussionModal'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/TagSelectionModal'];","function _setPrototypeOf(t, e) {\n  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) {\n    return t.__proto__ = e, t;\n  }, _setPrototypeOf(t, e);\n}\nexport { _setPrototypeOf as default };","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/classList'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/highlight'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/LoadingIndicator'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/common/helpers/tagIcon'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/common/utils/sortTags'];","import app from 'flarum/forum/app';\nimport classList from 'flarum/common/utils/classList';\nimport highlight from 'flarum/common/helpers/highlight';\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\n\nimport TagDiscussionModal, { type TagDiscussionModalAttrs } from 'flarum/tags/forum/components/TagDiscussionModal';\nimport tagIcon from 'flarum/tags/common/helpers/tagIcon';\nimport sortTags from 'flarum/tags/common/utils/sortTags';\nimport type Tag from 'flarum/tags/common/models/Tag';\n\ntype Vnode = Mithril.Vnode<TagDiscussionModalAttrs, GroupedTagDiscussionModal>;\n\ninterface ForumTagCategory {\n  id: number;\n  name: string;\n  slug: string | null;\n  order: number | null;\n  tagIds: number[];\n}\n\nexport default class GroupedTagDiscussionModal extends TagDiscussionModal<TagDiscussionModalAttrs> {\n  view(vnode: Vnode) {\n    return super.view(vnode);\n  }\n\n  content() {\n    // @ts-ignore 复用父类loading\n    if (this.loading) return <LoadingIndicator />;\n\n    const selectable: Tag[] =\n      // @ts-ignore 复用父类的 tags\n      (this.attrs.selectableTags ? this.attrs.selectableTags() : this.tags) || [];\n\n    // @ts-ignore 复用父类的 filter Stream\n    const filter: string = this.filter?.() || '';\n    const canSelect = this.attrs.canSelect || (() => true);\n    const visible = selectable.filter((t) => canSelect(t));\n\n    const filtered = visible.filter((tag) => {\n      if (!filter) return true;\n      const text = `${tag.name()} ${tag.description() || ''}`.toLowerCase();\n      return text.includes(filter.toLowerCase());\n    });\n\n    const categories: ForumTagCategory[] = (app.forum.attribute('tagCategories') as ForumTagCategory[]) || [];\n    const id2tag = new Map<number, Tag>(filtered.map((t) => [t.id() as number, t]));\n\n    const grouped = categories\n      .map((g) => {\n        const list = (g.tagIds || []).map((id) => id2tag.get(id)).filter(Boolean) as Tag[];\n        return { group: g, tags: sortTags(list.slice()) };\n      })\n      .filter((entry) => entry.tags.length > 0);\n\n    const groupedIdSet = new Set<number>();\n    grouped.forEach((e) => e.tags.forEach((t) => groupedIdSet.add(t.id() as number)));\n    const ungrouped = sortTags(filtered.filter((t) => !groupedIdSet.has(t.id() as number)));\n\n    // 如果没有任何可显示的分节，回退父类原始渲染\n    if (!grouped.length && !ungrouped.length) {\n      return super.content();\n    }\n\n    // 头部（输入框+提交按钮）沿用父类\n    // 下面只替换 footer 列表，把列表分节\n    // ---- header ----\n    const header = super.content()[0];\n    // ---- footer 替换为分组列表 ----\n    const renderSection = (title: string, tags: Tag[]) => (\n      <div className=\"lbtc-GroupSection\">\n        <div className=\"lbtc-GroupSection-title\">{title}</div>\n        <ul className=\"TagSelectionModal-list SelectTagList\">\n          {tags.map((tag) => this.renderTagItem(tag, filter))}\n        </ul>\n      </div>\n    );\n\n    return [\n      header,\n      <div className=\"Modal-footer lbtc-GroupedTagSelection\">\n        {grouped.map(({ group, tags }) => renderSection(group.name, tags))}\n        {ungrouped.length ? renderSection(app.translator.trans('lady-byron-tag-categories.forum.tag_selection.ungrouped') as unknown as string, ungrouped) : null}\n        {this.attrs.limits?.allowBypassing ? (\n          <div className=\"TagSelectionModal-controls\">\n            {/* @ts-ignore 复用父类字段 */}\n            <button className=\"Button\" onclick={() => (this.bypassReqs = !this.bypassReqs)}>\n              {app.translator.trans('flarum-tags.lib.tag_selection_modal.bypass_requirements')}\n            </button>\n          </div>\n        ) : null}\n      </div>,\n    ];\n  }\n\n  /** 与官方完全相同的单项结构，避免“多一个方块对勾”的问题 */\n  private renderTagItem(tag: Tag, filter: string) {\n    // @ts-ignore 复用父类状态\n    const active = this.indexTag === tag;\n    // @ts-ignore 复用父类 selected\n    const selected = this.selected.includes(tag);\n\n    return (\n      <li\n        data-index={tag.id()}\n        className={classList('SelectTagListItem', {\n          pinned: tag.position() !== null,\n          child: !!tag.parent(),\n          colored: !!tag.color(),\n          selected,\n          active,\n        })}\n        style={{ color: tag.color() || undefined }}\n        onmouseover={() => ((this as any).indexTag = tag)}\n        onclick={() => (this as any).toggleTag(tag)}\n      >\n        <i className=\"SelectTagListItem-icon\">\n          {tagIcon(tag, { className: 'SelectTagListItem-tagIcon' })}\n          {/* 关键：官方用于覆盖显示的对勾图标 */}\n          <i className=\"icon TagIcon fas fa-check SelectTagListItem-checkIcon\"></i>\n        </i>\n        <span className=\"SelectTagListItem-name\">{highlight(tag.name(), filter)}</span>\n        {tag.description() ? <span className=\"SelectTagListItem-description\">{tag.description()}</span> : null}\n      </li>\n    );\n  }\n}\n","import setPrototypeOf from \"./setPrototypeOf.js\";\nfunction _inheritsLoose(t, o) {\n  t.prototype = Object.create(o.prototype), t.prototype.constructor = t, setPrototypeOf(t, o);\n}\nexport { _inheritsLoose as default };","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionControls from 'flarum/forum/utils/DiscussionControls';\nimport Button from 'flarum/common/components/Button';\n\n// 原生弹窗\nimport TagDiscussionModal from 'flarum/tags/forum/components/TagDiscussionModal';\nimport TagSelectionModal from 'flarum/tags/forum/components/TagSelectionModal';\n\n// 我们的分组版弹窗（同时兼容“编辑已有讨论”和“新建时选择”两种场景）\nimport GroupedTagDiscussionModal from './components/GroupedTagDiscussionModal';\n\nconst EXT_ID = 'lady-byron/tag-categories';\n\napp.initializers.add(EXT_ID, () => {\n  const originalShow = app.modal.show.bind(app.modal);\n\n  // ✅ 统一在 show 入口替换，不在 oninit 里做切换，避免 Nested m.redraw.sync\n  (app.modal as any).show = function (component: any, attrs: any) {\n    const groups = app.forum.attribute('tagCategories') || [];\n\n    // 仅当站点存在分类组时才替换，保持无分组时沿用原生体验\n    if (groups.length && (component === TagDiscussionModal || component === TagSelectionModal)) {\n      component = GroupedTagDiscussionModal;\n    }\n\n    return originalShow(component, attrs);\n  };\n\n  // 兜底：讨论页“编辑标签”按钮也强制打开分组版\n  extend(DiscussionControls, 'moderationControls', function (items, discussion) {\n    if (discussion.canTag && discussion.canTag()) {\n      items.add(\n        'tags',\n        <Button icon=\"fas fa-tag\" onclick={() => app.modal.show(GroupedTagDiscussionModal, { discussion })}>\n          {app.translator.trans('flarum-tags.forum.discussion_controls.edit_tags_button')}\n        </Button>,\n        100\n      );\n    }\n  });\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","_setPrototypeOf","t","e","setPrototypeOf","bind","__proto__","GroupedTagDiscussionModal","_TagDiscussionModal","apply","arguments","create","constructor","_proto","view","vnode","content","_this$filter","_this$attrs$limits","_this","this","loading","m","LoadingIndicator","selectable","attrs","selectableTags","tags","filter","canSelect","visible","filtered","tag","name","description","toLowerCase","includes","categories","app","attribute","id2tag","Map","map","id","grouped","g","list","tagIds","Boolean","group","sortTags","slice","entry","length","groupedIdSet","Set","forEach","add","ungrouped","has","header","renderSection","title","className","renderTagItem","_ref","trans","limits","allowBypassing","onclick","bypassReqs","_this2","active","indexTag","selected","classList","pinned","position","child","parent","colored","color","style","undefined","onmouseover","toggleTag","tagIcon","highlight","TagDiscussionModal","originalShow","show","component","TagSelectionModal","extend","DiscussionControls","items","discussion","canTag","Button","icon"],"sourceRoot":""}