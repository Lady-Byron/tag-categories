{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://lady-byron-tag-categories/webpack/bootstrap","webpack://lady-byron-tag-categories/webpack/runtime/compat get default export","webpack://lady-byron-tag-categories/webpack/runtime/define property getters","webpack://lady-byron-tag-categories/webpack/runtime/hasOwnProperty shorthand","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['forum/app']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/extend']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['forum/utils/DiscussionControls']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/components/Button']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/TagDiscussionModal']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/forum/components/TagSelectionModal']\"","webpack://lady-byron-tag-categories/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/utils/classList']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/helpers/highlight']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['common/components/LoadingIndicator']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/common/helpers/tagIcon']\"","webpack://lady-byron-tag-categories/external root \"flarum.core.compat['tags/common/utils/sortTags']\"","webpack://lady-byron-tag-categories/./src/forum/components/GroupedTagDiscussionModal.tsx","webpack://lady-byron-tag-categories/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://lady-byron-tag-categories/./src/forum/index.tsx"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/utils/DiscussionControls'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/TagDiscussionModal'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/forum/components/TagSelectionModal'];","function _setPrototypeOf(t, e) {\n  return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) {\n    return t.__proto__ = e, t;\n  }, _setPrototypeOf(t, e);\n}\nexport { _setPrototypeOf as default };","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/classList'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/highlight'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/LoadingIndicator'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/common/helpers/tagIcon'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['tags/common/utils/sortTags'];","import app from 'flarum/forum/app';\nimport classList from 'flarum/common/utils/classList';\nimport highlight from 'flarum/common/helpers/highlight';\nimport LoadingIndicator from 'flarum/common/components/LoadingIndicator';\n\nimport TagDiscussionModal, { type TagDiscussionModalAttrs } from 'flarum/tags/forum/components/TagDiscussionModal';\nimport tagIcon from 'flarum/tags/common/helpers/tagIcon';\nimport sortTags from 'flarum/tags/common/utils/sortTags';\nimport type Tag from 'flarum/tags/common/models/Tag';\n\ntype Vnode = Mithril.Vnode<TagDiscussionModalAttrs, GroupedTagDiscussionModal>;\n\ninterface ForumTagCategory {\n  id: number;\n  name: string;\n  slug: string | null;\n  order: number | null;\n  tagIds: number[];\n}\n\nconst toKey = (id: string | number | undefined | null) => String(id ?? '');\n\nexport default class GroupedTagDiscussionModal extends TagDiscussionModal<TagDiscussionModalAttrs> {\n  view(vnode: Vnode) {\n    return super.view(vnode);\n  }\n\n  content() {\n    // 正在加载 tags：沿用父类的 loading 标志\n    // @ts-ignore\n    if (this.loading) return <LoadingIndicator />;\n\n    // 可选标签集合：沿用父类 props/约束\n    // @ts-ignore\n    const base: Tag[] = (this.attrs.selectableTags ? this.attrs.selectableTags() : this.tags) || [];\n\n    // @ts-ignore 父类的搜索 Stream\n    const filter: string = this.filter?.() || '';\n    const canSelect = this.attrs.canSelect || (() => true);\n\n    const visible = base.filter((t) => canSelect(t));\n    const filtered = visible.filter((tag) => {\n      if (!filter) return true;\n      const text = `${tag.name()} ${tag.description() || ''}`.toLowerCase();\n      return text.includes(filter.toLowerCase());\n    });\n\n    // —— 分组数据（来自 Forum 载荷）——\n    const categories: ForumTagCategory[] = (app.forum.attribute('tagCategories') as ForumTagCategory[]) || [];\n\n    // 关键修正：Map 的 key 统一用 string\n    const id2tag = new Map<string, Tag>(filtered.map((t) => [toKey(t.id()), t]));\n\n    const grouped = categories\n      .map((g) => {\n        const list = (g.tagIds || []).map((id) => id2tag.get(toKey(id))).filter(Boolean) as Tag[];\n        return { group: g, tags: sortTags(list.slice()) };\n      })\n      .filter((entry) => entry.tags.length > 0);\n\n    // 未分组：从过滤后集合里剔除已分组 ID\n    const groupedIdSet = new Set<string>();\n    grouped.forEach((e) => e.tags.forEach((t) => groupedIdSet.add(toKey(t.id()))));\n    const ungrouped = sortTags(filtered.filter((t) => !groupedIdSet.has(toKey(t.id()))));\n\n    // 如果没有任何分节，回退父类渲染\n    if (!grouped.length && !ungrouped.length) {\n      return super.content();\n    }\n\n    // 头部（输入框+提交按钮）直接复用父类的第一段\n    const parentChunks = super.content();\n    const header = Array.isArray(parentChunks) ? parentChunks[0] : parentChunks;\n\n    const renderSection = (title: string, tags: Tag[]) => (\n      <div className=\"lbtc-GroupSection\">\n        <div className=\"lbtc-GroupSection-title\">{title}</div>\n        <ul className=\"TagSelectionModal-list SelectTagList\">\n          {tags.map((tag) => this.renderTagItem(tag, filter))}\n        </ul>\n      </div>\n    );\n\n    return [\n      header,\n      <div className=\"Modal-footer lbtc-GroupedTagSelection\">\n        {grouped.map(({ group, tags }) => renderSection(group.name, tags))}\n        {ungrouped.length ? renderSection(app.translator.trans('lady-byron-tag-categories.forum.tag_selection.ungrouped') as unknown as string, ungrouped) : null}\n\n        {this.attrs.limits?.allowBypassing ? (\n          <div className=\"TagSelectionModal-controls\">\n            {/* @ts-ignore 复用父类字段 */}\n            <button className=\"Button\" onclick={() => (this.bypassReqs = !this.bypassReqs)}>\n              {app.translator.trans('flarum-tags.lib.tag_selection_modal.bypass_requirements')}\n            </button>\n          </div>\n        ) : null}\n      </div>,\n    ];\n  }\n\n  /** 单项渲染：完全对齐 flarum/tags 的结构和类名 */\n  private renderTagItem(tag: Tag, filter: string) {\n    // @ts-ignore\n    const active = this.indexTag === tag;\n    // @ts-ignore\n    const selected = Array.isArray(this.selected) && this.selected.includes(tag);\n\n    return (\n      <li\n        data-index={tag.id()}\n        className={classList('SelectTagListItem', {\n          pinned: tag.position() !== null,\n          child: !!tag.parent(),\n          colored: !!tag.color(),\n          selected,\n          active,\n        })}\n        style={{ color: tag.color() || undefined }}\n        onmouseover={() => ((this as any).indexTag = tag)}\n        onclick={() => (this as any).toggleTag(tag)}\n      >\n        <i className=\"SelectTagListItem-icon\">\n          {tagIcon(tag, { className: 'SelectTagListItem-tagIcon' })}\n          <i className=\"icon TagIcon fas fa-check SelectTagListItem-checkIcon\"></i>\n        </i>\n        <span className=\"SelectTagListItem-name\">{highlight(tag.name(), filter)}</span>\n        {tag.description() ? <span className=\"SelectTagListItem-description\">{tag.description()}</span> : null}\n      </li>\n    );\n  }\n}\n","import setPrototypeOf from \"./setPrototypeOf.js\";\nfunction _inheritsLoose(t, o) {\n  t.prototype = Object.create(o.prototype), t.prototype.constructor = t, setPrototypeOf(t, o);\n}\nexport { _inheritsLoose as default };","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport DiscussionControls from 'flarum/forum/utils/DiscussionControls';\nimport Button from 'flarum/common/components/Button';\n\n// 原生弹窗\nimport TagDiscussionModal from 'flarum/tags/forum/components/TagDiscussionModal';\nimport TagSelectionModal from 'flarum/tags/forum/components/TagSelectionModal';\n\n// 我们的分组版弹窗（同时兼容“编辑已有讨论”和“新建时选择”两种场景）\nimport GroupedTagDiscussionModal from './components/GroupedTagDiscussionModal';\n\nconst EXT_ID = 'lady-byron/tag-categories';\n\napp.initializers.add(EXT_ID, () => {\n  const originalShow = app.modal.show.bind(app.modal);\n\n  // ✅ 统一在 show 入口替换，不在 oninit 里做切换，避免 Nested m.redraw.sync\n  (app.modal as any).show = function (component: any, attrs: any) {\n    const groups = app.forum.attribute('tagCategories') || [];\n\n    // 仅当站点存在分类组时才替换，保持无分组时沿用原生体验\n    if (groups.length && (component === TagDiscussionModal || component === TagSelectionModal)) {\n      component = GroupedTagDiscussionModal;\n    }\n\n    return originalShow(component, attrs);\n  };\n\n  // 兜底：讨论页“编辑标签”按钮也强制打开分组版\n  extend(DiscussionControls, 'moderationControls', function (items, discussion) {\n    if (discussion.canTag && discussion.canTag()) {\n      items.add(\n        'tags',\n        <Button icon=\"fas fa-tag\" onclick={() => app.modal.show(GroupedTagDiscussionModal, { discussion })}>\n          {app.translator.trans('flarum-tags.forum.discussion_controls.edit_tags_button')}\n        </Button>,\n        100\n      );\n    }\n  });\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","_setPrototypeOf","t","e","setPrototypeOf","bind","__proto__","toKey","id","String","GroupedTagDiscussionModal","_TagDiscussionModal","apply","arguments","create","constructor","_proto","view","vnode","content","_this$filter","_this$attrs$limits","_this","this","loading","m","LoadingIndicator","base","attrs","selectableTags","tags","filter","canSelect","visible","filtered","tag","name","description","toLowerCase","includes","categories","app","attribute","id2tag","Map","map","grouped","g","list","tagIds","Boolean","group","sortTags","slice","entry","length","groupedIdSet","Set","forEach","add","ungrouped","has","parentChunks","header","Array","isArray","renderSection","title","className","renderTagItem","_ref","trans","limits","allowBypassing","onclick","bypassReqs","_this2","active","indexTag","selected","classList","pinned","position","child","parent","colored","color","style","undefined","onmouseover","toggleTag","tagIcon","highlight","TagDiscussionModal","originalShow","show","component","TagSelectionModal","extend","DiscussionControls","items","discussion","canTag","Button","icon"],"sourceRoot":""}